name: Manual Release

on:
  workflow_dispatch:
    inputs:
      bump-type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
      dry-run:
        description: 'Dry run (skip npm publish and git push)'
        required: false
        type: boolean
        default: false

jobs:
  release:
    name: Release to npm
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ vars.TURBO_TEAM }}
    steps:
      - name: Verify main branch
        if: github.ref != 'refs/heads/main'
        run: |
          echo "Error: This workflow can only be run from the main branch"
          echo "Current ref: ${{ github.ref }}"
          exit 1

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint

      - name: Build
        run: bun run build

      - name: Setup git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Test
        run: bun run test-ci

      - name: Bump version
        id: bump
        working-directory: apps/cli
        run: |
          CURRENT_VERSION=$(bun -e "console.log(require('./package.json').version)")
          echo "Current version: $CURRENT_VERSION"

          NEW_VERSION=$(bun pm version ${{ inputs.bump-type }} --no-git-tag-version)
          echo "New version: $NEW_VERSION"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_version_number=${NEW_VERSION#v}" >> $GITHUB_OUTPUT

      - name: Check for remote changes
        run: |
          git fetch origin main
          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse origin/main)
          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "Error: Remote main has new commits. Please re-run the workflow."
            echo "Local:  $LOCAL"
            echo "Remote: $REMOTE"
            exit 1
          fi

      - name: Publish to npm
        if: inputs.dry-run != true
        working-directory: apps/cli
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: bun publish --access public

      - name: Commit version bump
        if: inputs.dry-run != true
        run: |
          git add apps/cli/package.json
          git commit -m "${{ steps.bump.outputs.new_version }}"

      - name: Push changes
        if: inputs.dry-run != true
        run: git push origin main

      - name: Create summary
        run: |
          if [ "${{ inputs.dry-run }}" == "true" ]; then
            echo "## Dry Run Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Would have released version **${{ steps.bump.outputs.new_version }}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No changes were published or pushed." >> $GITHUB_STEP_SUMMARY
          else
            echo "## Release Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Successfully released version **${{ steps.bump.outputs.new_version }}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- npm: https://www.npmjs.com/package/@da1z/pancake/v/${{ steps.bump.outputs.new_version_number }}" >> $GITHUB_STEP_SUMMARY
          fi
